
(function(window,document,videojs,undefined){"use strict";var
extend=function(obj){var arg,i,k;for(i=1;i<arguments.length;i++){arg=arguments[i];for(k in arg){if(arg.hasOwnProperty(k)){obj[k]=arg[k];}}}
return obj;},on=function(obj,events,handler){var
type=Object.prototype.toString.call(events),register=function(obj,event,handler){if(obj.addEventListener){obj.addEventListener(event,handler);}else if(obj.on){obj.on(event,handler);}else if(obj.attachEvent){obj.attachEvent('on'+event,handler);}else{throw new Error('object has no mechanism for adding event listeners');}},i,ii;switch(type){case'[object String]':register(obj,events,handler);break;case'[object Array]':for(i=0,ii=events.length;i<ii;i++){register(obj,events[i],handler);}
break;case'[object Object]':for(i in events){if(events.hasOwnProperty(i)){register(obj,i,events[i]);}}
break;default:throw new Error('Unrecognized events parameter type: '+type);}
return obj;},defer=function(callback){return window.setTimeout(callback,1);},undefer=function(id){return window.clearTimeout(id);},cancelContentPlay=function(player){if(player.ads.cancelPlayTimeout){return;}
player.ads.cancelPlayTimeout=defer(function(){player.ads.cancelPlayTimeout=null;if(!player.paused()){player.pause();}
player.one('contentplayback',function(){if(player.paused()){player.play();}});});},getPlayerSnapshot=function(player){var
tech=player.el().querySelector('.vjs-tech'),tracks=player.remoteTextTracks?player.remoteTextTracks():[],track,i,suppressedTracks=[],snapshot={ended:player.ended(),src:player.currentSrc(),currentTime:player.currentTime(),type:player.currentType()};if(tech){snapshot.nativePoster=tech.poster;snapshot.style=tech.getAttribute('style');}
i=tracks.length;while(i--){track=tracks[i];suppressedTracks.push({track:track,mode:track.mode});track.mode='disabled';}
snapshot.suppressedTracks=suppressedTracks;return snapshot;},removeClass=function(element,className){var
classes=element.className.split(/\s+/),i=classes.length,newClasses=[];while(i--){if(classes[i]!==className){newClasses.push(classes[i]);}}
element.className=newClasses.join(' ');},restorePlayerSnapshot=function(player,snapshot){var
tech=player.el().querySelector('.vjs-tech'),attempts=20,suppressedTracks=snapshot.suppressedTracks,trackSnapshot,restoreTracks=function(){var i=suppressedTracks.length;while(i--){trackSnapshot=suppressedTracks[i];trackSnapshot.track.mode=trackSnapshot.mode;}},resume=function(){var
ended=false,updateEnded=function(){ended=true;};player.currentTime(snapshot.currentTime);if(!snapshot.ended){player.play();}else{player.ads.resumeEndedTimeout=window.setTimeout(function(){if(!ended){player.play();}
player.off('ended',updateEnded);player.ads.resumeEndedTimeout=null;},250);player.on('ended',updateEnded);player.on('dispose',function(){window.clearTimeout(player.ads.resumeEndedTimeout);});}},tryToResume=function(){if(tech.readyState>1){return resume();}
if(tech.seekable===undefined){return resume();}
if(tech.seekable.length>0){return resume();}
if(attempts--){window.setTimeout(tryToResume,50);}else{(function(){try{resume();}catch(e){videojs.log.warn('Failed to resume the content after an advertisement',e);}})();}},srcChanged;if(snapshot.nativePoster){tech.poster=snapshot.nativePoster;}
if('style'in snapshot){tech.setAttribute('style',snapshot.style||'');}
if(player.src()){srcChanged=player.src()!==snapshot.src;}else{srcChanged=player.currentSrc()!==snapshot.src;}
if(srcChanged){player.one('contentloadedmetadata',restoreTracks);player.src({src:snapshot.src,type:snapshot.type});player.load();player.one('contentcanplay',tryToResume);}else if(!player.ended()||!snapshot.ended){restoreTracks();player.play();}},removeNativePoster=function(player){var tech=player.el().querySelector('.vjs-tech');if(tech){tech.removeAttribute('poster');}},defaults={timeout:5000,prerollTimeout:100,postrollTimeout:100,debug:false},adFramework=function(options){var
player=this,settings=extend({},defaults,options||{}),fsmHandler;(function(){var
videoEvents=videojs.getComponent('Html5').Events,i,returnTrue=function(){return true;},triggerEvent=function(type,event){event.isImmediatePropagationStopped=returnTrue;event.cancelBubble=true;event.isPropagationStopped=returnTrue;player.trigger({type:type+event.type,state:player.ads.state,originalEvent:event});},redispatch=function(event){if(player.ads.state==='ad-playback'){triggerEvent('ad',event);}else if(player.ads.state==='content-playback'&&event.type==='ended'){triggerEvent('content',event);}else if(player.ads.state==='content-resuming'){if(player.ads.snapshot){if(player.currentSrc()!==player.ads.snapshot.src){if(event.type==='loadstart'){return;}
return triggerEvent('content',event);}else if(player.ads.snapshot.ended){if((event.type==='pause'||event.type==='ended')){player.addClass('vjs-has-started');return;}
return triggerEvent('content',event);}}
if(event.type!=='playing'){triggerEvent('content',event);}}};videoEvents.push('firstplay');videoEvents.push('loadedalldata');i=videoEvents.length;while(i--){player.on(videoEvents[i],redispatch);}
return redispatch;})();player.on(['addurationchange','adcanplay'],function(){var snapshot=player.ads.snapshot;if(player.currentSrc()===snapshot.src){return;}
player.play();});player.ads={state:'content-set',startLinearAdMode:function(){if(player.ads.state!=='ad-playback'){player.trigger('adstart');}},endLinearAdMode:function(){if(player.ads.state==='ad-playback'){player.trigger('adend');}},skipLinearAdMode:function(){if(player.ads.state!=='ad-playback'){player.trigger('adskip');}}};fsmHandler=function(event){var
fsm={'content-set':{events:{'adscanceled':function(){this.state='content-playback';},'adsready':function(){this.state='ads-ready';},'play':function(){this.state='ads-ready?';cancelContentPlay(player);removeNativePoster(player);},'adserror':function(){this.state='content-playback';},'adskip':function(){this.state='content-playback';}}},'ads-ready':{events:{'play':function(){this.state='preroll?';cancelContentPlay(player);},'adskip':function(){this.state='content-playback';},'adserror':function(){this.state='content-playback';}}},'preroll?':{enter:function(){player.el().className+=' vjs-ad-loading';player.ads.adTimeoutTimeout=window.setTimeout(function(){player.trigger('adtimeout');},settings.prerollTimeout);player.trigger('readyforpreroll');},leave:function(){window.clearTimeout(player.ads.adTimeoutTimeout);removeClass(player.el(),'vjs-ad-loading');},events:{'play':function(){cancelContentPlay(player);},'adstart':function(){this.state='ad-playback';},'adskip':function(){this.state='content-playback';},'adtimeout':function(){this.state='content-playback';},'adserror':function(){this.state='content-playback';}}},'ads-ready?':{enter:function(){player.el().className+=' vjs-ad-loading';player.ads.adTimeoutTimeout=window.setTimeout(function(){player.trigger('adtimeout');},settings.timeout);},leave:function(){window.clearTimeout(player.ads.adTimeoutTimeout);removeClass(player.el(),'vjs-ad-loading');},events:{'play':function(){cancelContentPlay(player);},'adscanceled':function(){this.state='content-playback';},'adsready':function(){this.state='preroll?';},'adskip':function(){this.state='content-playback';},'adtimeout':function(){this.state='content-playback';},'adserror':function(){this.state='content-playback';}}},'ad-playback':{enter:function(){this.snapshot=getPlayerSnapshot(player);player.el().className+=' vjs-ad-playing';removeNativePoster(player);if(player.ads.cancelPlayTimeout){undefer(player.ads.cancelPlayTimeout);player.ads.cancelPlayTimeout=null;}},leave:function(){removeClass(player.el(),'vjs-ad-playing');restorePlayerSnapshot(player,this.snapshot);if(player.ads.triggerevent!=='adend'){player.trigger('adend');}},events:{'adend':function(){this.state='content-resuming';},'adserror':function(){this.state='content-resuming';}}},'content-resuming':{enter:function(){if(this.snapshot.ended){window.clearTimeout(player.ads._fireEndedTimeout);player.ads._fireEndedTimeout=window.setTimeout(function(){player.trigger('ended');},1000);}},leave:function(){window.clearTimeout(player.ads._fireEndedTimeout);},events:{'contentupdate':function(){this.state='content-set';},contentresumed:function(){this.state='content-playback';},'playing':function(){this.state='content-playback';},'ended':function(){this.state='content-playback';}}},'postroll?':{enter:function(){this.snapshot=getPlayerSnapshot(player);player.el().className+=' vjs-ad-loading';player.ads.adTimeoutTimeout=window.setTimeout(function(){player.trigger('adtimeout');},settings.postrollTimeout);},leave:function(){window.clearTimeout(player.ads.adTimeoutTimeout);removeClass(player.el(),'vjs-ad-loading');},events:{'adstart':function(){this.state='ad-playback';},'adskip':function(){this.state='content-resuming';defer(function(){player.trigger('ended');});},'adtimeout':function(){this.state='content-resuming';defer(function(){player.trigger('ended');});},'adserror':function(){this.state='content-resuming';defer(function(){player.trigger('ended');});}}},'content-playback':{enter:function(){if(player.ads.cancelPlayTimeout){undefer(player.ads.cancelPlayTimeout);player.ads.cancelPlayTimeout=null;}
player.trigger({type:'contentplayback',triggerevent:player.ads.triggerevent});},events:{'adsready':function(){player.trigger('readyforpreroll');},'adstart':function(){this.state='ad-playback';},'contentupdate':function(){if(player.paused()){this.state='content-set';}else{this.state='ads-ready?';}},'contentended':function(){this.state='postroll?';}}}};(function(state){var noop=function(){};((fsm[state].events||{})[event.type]||noop).apply(player.ads);if(state!==player.ads.state){player.ads.triggerevent=event.type;(fsm[state].leave||noop).apply(player.ads);(fsm[player.ads.state].enter||noop).apply(player.ads);if(settings.debug){videojs.log('ads',player.ads.triggerevent+' triggered: '+state+' -> '+player.ads.state);}}})(player.ads.state);};on(player,videojs.getComponent('Html5').Events.concat(['adtimeout','contentupdate','contentplaying','contentended','contentresumed','adsready','adserror','adscanceled','adstart','adend','adskip']),fsmHandler);player.ads.contentSrc=player.currentSrc();(function(){var
checkSrc=function(){var src;if(player.ads.state!=='ad-playback'){src=player.currentSrc();if(src!==player.ads.contentSrc){player.trigger({type:'contentupdate',oldValue:player.ads.contentSrc,newValue:src});player.ads.contentSrc=src;}}};player.on('loadstart',checkSrc);defer(checkSrc);})();if(!player.paused()){fsmHandler({type:'play'});}};videojs.plugin('ads',adFramework);})(window,document,videojs);